<template>
	<style>
		#pianoroll {
			position: relative;
			left: 0px;
			top: 0px;
			white-space: nowrap;
			margin: 0px;
			padding: 0px;
		}
		#bgCanvas {
			position: relative;
			left: 0px;
			top: 0px;
			margin: 0px;
			padding: 0px;
		}
		#fgCanvas {
			position: relative;
			left: -1204px;
			top: 0px;
			margin: 0px;
			padding: 0px;
		}
	</style>
	<div id="pianoroll" style="" oncontextmenu="return false;">
		<canvas id="bgCanvas" width="1200" height="560"></canvas>
		<canvas id="fgCanvas" width="1200" height="560"></canvas>
	</div>
</template>
<script>
    (function(){
		// declare a persistent canvas
		var canvas;

		// get the template for this element
		var template = document.currentScript.ownerDocument.querySelector('template');

		// copy a prototype from HTMLElement
		var pianorollPrototype = Object.create(HTMLElement.prototype);

		// keep track of mouse coordinates
		var mouseX, mouseY;
		var prevX, prevY, prevMX, prevMY;

		// keep track of clicked key info
		var keyHeight, keyType, keyValue;

		// keep track of displayed notes
		var noteset = new NoteSet();

		// current cursor mode. Options: draw, select
		var mode = 'draw';

		// specify the created callback ("constructor")
		pianorollPrototype.createdCallback = function(){
			var root = this.createShadowRoot();
			root.appendChild(document.importNode(template.content, true));
			canvas = root.querySelector('#bgCanvas');
			var context = canvas.getContext("2d");
			var width = canvas.getAttribute("width");
			var height = canvas.getAttribute("height");

			// fill the canvas background
			context.beginPath();
			context.rect(1, 1, width-2, height-2);
			context.fillStyle = "#EEEEEE";			
			context.fill();

			// draw the black key bars
			var on = true;
			var times = 0;
			for(var i = 30.0; i < height; i += 20.0){
				times++;
				context.beginPath();
				context.rect(0, i, width, 20);
				context.linewidth = 5;
				if(on && times !== 7 && times !== 13){
					context.strokeStyle = "#000000";
					context.fillStyle = "#BBBBBB";
					context.fill();
					context.stroke();
					on = false;
				} else {
					on = true;
				}
				if(times === 7 || times === 13)
					on = false;
				if(times > 14)
					times = 1;
			}

			// draw the no-black-key bars
			on = true;
			for(var i = 160.0; i < height;){
				context.beginPath();
				context.moveTo(0, i);
				context.lineTo(width, i);
				context.linewidth = 5;
				context.strokeStyle = "#000000";
				context.fillStyle = "#AAAAAA";
				context.fill();
				context.stroke();
				if(on){
					on = false;
					i += 120;
				} else {
					on = true;
					i += 160;
				}
			}

			// draw the measure bars
			for(var i = 0.0; i < width; i += 40.0){
				context.beginPath();
				context.linewidth = 5;
				//context.rect(i, 0, 40, height);
				context.moveTo(i, 0);
				context.lineTo(i, height);
				if(i % 160 === 0.0){
					//context.fillStyle = "#AAAAAA";
					context.strokeStyle = "#000000";
				} else {
					//context.fillStyle = "#CCCCCC";
					context.strokeStyle = "#666666";
				}
				context.fill();
				context.stroke();
			}

			// outline the canvas
			context.beginPath();
			context.rect(1, 1, width-2, height-2);
			context.linewidth = 5;
			context.strokeStyle = "#000000";
			context.stroke();

			canvas = root.querySelector('#fgCanvas');
			context = canvas.getContext("2d");

			// add mouse event handling
			canvas.addEventListener('mousemove', function(){
				if(mode === 'draw'){
					canvas.style.cursor = 'cell';
					if(typeof mouseX !== 'undefined' && typeof mouseY !== 'undefined')
						if(typeof prevX === 'undefined' && typeof prevY === 'undefined'){
							prevX = mouseX;
							prevY = mouseY;
						} else {
							// draw a preview rectangle
							var pageOffset = document.body.getBoundingClientRect();
							var offset = canvas.getBoundingClientRect();
							var x = event.pageX - (offset.left - pageOffset.left) - mouseX;
							var y = keyHeight;
							var sign = x === 0 ? 1 : Math.abs(x)/x;
							x = x - x % 40 + 40;
							
							var color;

							if(keyType === "white"){
								color = "#AAAAFF";
							} else {
								color = "#6666AA";
							}
							
							//erase the old rectangle
							context.clearRect(prevMX-1, prevMY-1, prevX+2, prevY+2);

							// deal with backwards note drawing
							if(sign < 0){
								drawRect(context, {left: mouseX + x - 80, top: mouseY, right: -(x - 80) + 40, bottom: y}, color, "#000044", 5);

								prevMX = mouseX + x - 80;
								prevMY = mouseY;
								prevX = -(x - 80) + 40;
								prevY = y;
							} else {
								drawRect(context, {left: mouseX, top: mouseY, right: x, bottom: y}, color, "#000044", 5);

								prevMX = mouseX;
								prevMY = mouseY;
								prevX = x;
								prevY = y;
							}
						}

				}
				else
					canvas.style.cursor = 'auto';
			});


			canvas.addEventListener('mousedown',
				function(){
					// get page coordinates for the mouse that account for scrolling
					var pageOffset = document.body.getBoundingClientRect();
					var offset = canvas.getBoundingClientRect();
					mouseX = event.pageX - (offset.left - pageOffset.left);
					mouseY = event.pageY - (offset.top - pageOffset.top) - 8;

					// calculate effective pixel positions for the piano roll
					mouseX = mouseX - mouseX % 40;
					mouseY = mouseY - mouseY % 10;

					var effectiveY = mouseY % 280;
					keyValue = 24 - Math.floor(mouseY / 280) * 12;

					if(effectiveY === 0){			// B
						keyHeight = 30;
						keyType = "white";
						keyValue -= 0;
					} else if(effectiveY === 10){
						keyHeight = 30;
						keyType = "white";
						mouseY -= 10;
						keyValue -= 0;
					} else if(effectiveY === 20){
						keyHeight = 30;
						keyType = "white";
						mouseY -= 20;
						keyValue -= 0;
					} else if(effectiveY === 30){	// B Flat
						keyHeight = 20;
						keyType = "black";
						keyValue -= 1;
					} else if(effectiveY === 40){
						keyHeight = 20;
						keyType = "black";
						mouseY -= 10;
						keyValue -= 1;
					} else if(effectiveY === 50){	// A
						keyHeight = 20;
						keyType = "white";
						keyValue -= 2;
					} else if(effectiveY === 60){
						keyHeight = 20;
						keyType = "white";
						mouseY -= 10;
						keyValue -= 2;
					} else if(effectiveY === 70){	// A flat
						keyHeight = 20;
						keyType = "black";
						keyValue -= 3;
					} else if(effectiveY === 80){
						keyHeight = 20;
						keyType = "black";
						mouseY -= 10;
						keyValue -= 3;
					} else if(effectiveY === 90){	// G
						keyHeight = 20;
						keyType = "white";
						keyValue -= 4;
					} else if(effectiveY === 100){
						keyHeight = 20;
						keyType = "white";
						mouseY -= 10;
						keyValue -= 4;
					} else if(effectiveY === 110){	// F sharp
						keyHeight = 20;
						keyType = "black";
						keyValue -= 5;
					} else if(effectiveY === 120){
						keyHeight = 20;
						keyType = "black";
						mouseY -= 10;
						keyValue -= 5;
					} else if(effectiveY === 130){	// F
						keyHeight = 30;
						keyType = "white";
						keyValue -= 6;
					} else if(effectiveY === 140){
						keyHeight = 30;
						keyType = "white";
						mouseY -= 10;
						keyValue -= 6;
					} else if(effectiveY === 150){
						keyHeight = 30;
						keyType = "white";
						mouseY -= 20;
						keyValue -= 6;
					} else if(effectiveY === 160){	// E
						keyHeight = 30;
						keyType = "white";
						keyValue -= 7;
					} else if(effectiveY === 170){
						keyHeight = 30;
						keyType = "white";
						mouseY -= 10;
						keyValue -= 7;
					} else if(effectiveY === 180){
						keyHeight = 30;
						keyType = "white";
						mouseY -= 20;
						keyValue -= 7;
					} else if(effectiveY === 190){	// E flat
						keyHeight = 20;
						keyType = "black";
						keyValue -= 8;
					} else if(effectiveY === 200){
						keyHeight = 20;
						keyType = "black";
						mouseY -= 10;
						keyValue -= 8;
					} else if(effectiveY === 210){	// D
						keyHeight = 20;
						keyType = "white";
						keyValue -= 9;
					} else if(effectiveY === 220){
						keyHeight = 20;
						keyType = "white";
						mouseY -= 10;
						keyValue -= 9;
					} else if(effectiveY === 230){	// C sharp
						keyHeight = 20;
						keyType = "black";
						keyValue -= 10;
					} else if(effectiveY === 240){
						keyHeight = 20;
						keyType = "black";
						mouseY -= 10;
						keyValue -= 10;
					} else if(effectiveY === 250){	// C
						keyHeight = 30;
						keyType = "white";
						keyValue -= 11;
					} else if(effectiveY === 260){
						keyHeight = 30;
						keyType = "white";
						mouseY -= 10;
						keyValue -= 11;
					} else if(effectiveY === 270){
						keyHeight = 30;
						keyType = "white";
						mouseY -= 20;
						keyValue -= 11;
					} else {
						keyHeight = 20;
						keyType = "white";
					}

					// select the clicked-on note
					var measure = Math.floor(mouseX / 160) + 1;
					var beat = ((mouseX % 160) / 40) + 1;
					
					if(mode === 'select'){
						noteset.SelectNote({detail: {keyvalue: keyValue, measure: measure, beat: beat}});
					}
				});
			canvas.addEventListener('mouseup',
				function(){
					// don't draw anything if mouseX or mouseY originated outside of the canvas
					if(typeof mouseX === 'undefined' || typeof mouseY === 'undefined'){
						return;
					}

					var keyEvent;
					// get page coordinates for the mouse that account for scrolling
					var pageOffset = document.body.getBoundingClientRect();
					var offset = canvas.getBoundingClientRect();
					var x = event.pageX - (offset.left - pageOffset.left) - mouseX;
					//var x = event.pageX - 100.0 - mouseX;
					
					var sign = x === 0 ? 1 : Math.abs(x)/x;
					x = x - x % 40 + 40;

					// deal with backwards note drawing
					if(sign < 0){
						mouseX += x - 80;
						x = -x + 120;
					}

					var measure = Math.floor(mouseX / 160) + 1;
					var beat = ((mouseX % 160) / 40) + 1;
					var duration = (x / 40);
					var y = keyHeight;
					var color;
					var tickstart = (measure * 4 + beat) * 480; // currently 4/4 time, 480 ticks per beat
					var tickduration = duration * 480; // 480 ticks per beat

					if(keyType === "white"){
						color = "#AAAAFF";
					} else {
						color = "#6666AA";
					}

					if(event.button === 2.0){
						context.clearRect(mouseX-1, mouseY-1, x+2, y+2);
						keyEvent = new CustomEvent("denoto-erasenote", {"detail":{"keyvalue": keyValue, "measure": measure, "beat": beat, "duration": duration, "tickstart": tickstart, "tickduration": tickduration}}); // possibly remove measure/beat/duration if not used in final model
					} else {
						drawRect(context, {left: mouseX, top: mouseY, right: x, bottom: y}, color, "#000044", 5);
						keyEvent = new CustomEvent("denoto-writenote", {"detail":{"keyvalue": keyValue, "measure": measure, "beat": beat, "duration": duration, "tickstart": tickstart, "tickduration": tickduration}}); // possibly remove measure/beat/duration if not used in final model
					}

					// behavior differs based on state
					if(mode === 'draw'){
						// let the noteset handle the event
						noteset.AddNote(new Note(keyEvent));
						console.log(noteset);

						// dispatch the event so that listeners can handle it
						root.host.dispatchEvent(keyEvent);
					} else if(mode === 'select'){
						// try to grab a note from the noteset
						var myNote = noteset.SelectNote(keyEvent);
						console.log(myNote);
					}

					// reset mouseX and mouseY to undefined
					mouseX = undefined;
					mouseY = undefined;
					prevX = undefined;
					prevY = undefined;
					prevMX = undefined;
					prevMY = undefined;
				});

			// ensure that mouseX and mouseY are returned to undefined when mousing out of the canvas
			canvas.addEventListener('mouseout',
				function(){
					mouseX = undefined;
					mouseY = undefined;
					prevX = undefined;
					prevY = undefined;
					prevMX = undefined;
					prevMY = undefined;
				});
		};

		// register the element
		var pianoroll = document.registerElement('denoto-pianoroll', {prototype: pianorollPrototype});
})();

// represents a set of notes to be displayed
function NoteSet(){
	this.currentID = 0;
	this.lanes = new Array();
	for(var i = 1; i <= 24; i++){
		this.lanes[i] = new Array();
	}
}

// adds a note to the noteset
NoteSet.prototype.AddNote = function(note){
	// assign a new ID if the note doesn't already have one
	if(typeof note.ID === 'undefined')
		note.ID = this.currentID++;

	// put the note in each place a click will correspond to it
	var lane = this.lanes[note.keyValue];
	for(var i = note.start; i < note.end; i++){
		lane[i] = note;
	}
}

// selects a note from the noteset
NoteSet.prototype.SelectNote = function(event){
	var lane = event.detail.keyvalue;
	var index = (event.detail.measure - 1) * 4 + event.detail.beat;

	//console.log(this.lanes[lane][index]);
	return this.lanes[lane][index];
}

// removes a note from the noteset
NoteSet.prototype.RemoveNote = function(note){
	// remove the note from each place it was found
	for(var i = start; i < end; i++){
		this.lanes[note.keyValue][i] = null;
	}
}

// represents a single note that exists in the pianoroll
function Note(event){
	this.keyValue = event.detail.keyvalue;
	this.duration = event.detail.duration;
	this.start = (event.detail.measure - 1) * 4 + event.detail.beat;
	this.end = this.start + event.detail.duration;
	this.measure = event.detail.measure;
	this.beat = event.detail.beat;
	this.tickstart = event.detail.tickstart;
	this.tickduration = event.detail.tickduration;
}




















</script>