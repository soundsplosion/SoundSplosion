<head>
  <script src="/assets/jquery.min.js"></script>
  <link rel="import" href="<%= asset_path("pianoroll.html")%>">
  <link rel="import" href="<%= asset_path("trackview.html")%>">
  <link rel="import" href="<%= asset_path("transport.html")%>">
  <link rel="import" href="<%= asset_path("savebar.html")%>">
  <link rel="import" href="<%= asset_path("loopcontrol.html")%>">
  <link rel="import" href="<%= asset_path("guidescontrol.html")%>">
  <link rel="import" href="<%= asset_path("musicclock.html")%>">
  <link rel="import" href="<%= asset_path("countdown.html")%>">
  <link rel="import" href="<%= asset_path("editabletext.html")%>">
  <link rel="import" href="<%= asset_path("quantization.html")%>">
  <link rel="import" href="<%= asset_path("endmarker.html")%>">
  <link rel="import" href="<%= asset_path("tabset.html")%>">
  <link rel="import" href="<%= asset_path("effectsgraph.html")%>">
  <link rel="import" href="<%= asset_path("shadowbox.css.erb")%>">
  <script src="<%= asset_path("shadowbox.js")%>"></script>
  <script src="<%= asset_path("graph.js")%>"></script>
  <script src="<%= asset_path("recorder.js")%>"></script>
</head>
<!-- background: #252477; old purplish color 062A78-->
<style type="text/css">
  @font-face{
    font-family: 'Oswald';
    src: url('<%= asset_path("Oswald-Regular.ttf")%>');
  }

  #midi-interface {
    position: absolute;
    top: 150px;
    width: 100%;
  }
  body{
    font-family: 'Oswald', sans-serif;
  }
  #top-bar{
    /*background: #252477;*/
    background: #172837;
    height: 100px;
    width: 100%;
    position: fixed;
    top: 51px;
    z-index: 6;
    padding: 10px;
    color: #FFFFFF;
  }
  denoto-transportbar{
    margin-left: auto;
    margin-right: auto;
    width: 30%;
  }
  denoto-countdown{
    position: absolute;
    top: 25px;
    right: 270px;
  }
  denoto-savebar{
    float: right;
  }
  .navbar{
    position: fixed;
    z-index: 5;
    width: 100%;
  }
  #header_name{
    opacity: 0.9;
    text-align: center;
    font-size: 20px;
    position: relative;
    left: 100px;
  }
</style>

<div id="top-bar" height="75px">
  <denoto-transportbar id="transportbar"></denoto-transportbar>
  <denoto-editabletext id="header_name" type="longtext" width="300"></denoto-editabletext>
  <denoto-savebar id="savebar"></denoto-savebar>
  <br />
  <denoto-guidescontrol id="guidescontrol"></denoto-guidescontrol><denoto-quantizationcontrol id="quantizationcontrol"></denoto-quantizationcontrol><denoto-musicclock id="musicclock"></denoto-musicclock><denoto-endmarker id="endmarkercontrol"></denoto-endmarker></denoto-musicclock>
  <br />
  <denoto-loopcontrol id="loopcontrol"></denoto-loopcontrol>
  <denoto-tabset id="tabset"></denoto-tabset>
</div>

<div id="midi-interface">
  <denoto-trackview id="apptrackview"></denoto-trackview>
</div>
<a id="exp_imp_link"></a>

<input type="file" id="txt_input" /> 

<script>
  document.addEventListener("keydown", function(){
    if(event.keyCode === 8 && event.path[0].outerHTML.substring(1,6).toUpperCase() !== "INPUT" ){
      event.preventDefault(); // keep the stupid browser back from activation on backspace
    }
  });

  function render(){
    // this is just a dummy function for now
  }

  // instantiate Rhombus
  var rhomb = new Rhombus();  
  var save_span = $(savebar.shadowRoot.childNodes[3]);
  var lastKeypressed = 0;

  // keep track of the starting position
  var startPosition = rhomb.seconds2Ticks(rhomb.getPosition());

  // initialize the time display
  var timeEvent = new CustomEvent("denoto-setcurrenttime", {"detail": {"measure": 1, "beat": 1, "quarter_beat": 1, "tick": 0}});
  document.dispatchEvent(timeEvent);

  // initialize the BPM display
  var bpm = rhomb.getBpm();
  var bpmEvent = new CustomEvent("denoto-setbpm", {"detail": {"bpm" : bpm}});
  document.dispatchEvent(bpmEvent);

  // keyboard events
  document.addEventListener("denoto-keydown",
    function(e){
      rhomb.startPreviewNote(e.detail.keyvalue);
    });
  document.addEventListener("denoto-keyup",
    function(e) {
      rhomb.stopPreviewNote(e.detail.keyvalue);
    });

  // piano roll events
  document.addEventListener("denoto-writenote",
    function(e){
      console.log("[PianoRoll] Writing note ID " + e.detail.note._id + " at tick " + e.detail.note._start + ", length " + e.detail.note._length);
      rhomb.Edit.insertNote(e.detail.note, e.detail.ptnId);
    });
  document.addEventListener("denoto-erasenote",
    function(e){
      console.log("[PianoRoll] Erasing note ID " + e.detail.note._id + " at tick " + e.detail.note._start);
      rhomb.Edit.deleteNote(e.detail.note._id, e.detail.ptnId);
    });
  document.addEventListener("denoto-updatenote",
  function(e){
    console.log("[PianoRoll] Updating note ID " + e.detail.note._id + " at tick " + e.detail.note._start + ", length " + e.detail.note._length);
    rhomb.Edit.changeNoteTime(e.detail.note._id, e.detail.note._start, e.detail.note._length, e.detail.ptnId);
  });

  document.addEventListener("denoto-updatestartpos",
    function(e) {
      // TODO: determine if it's better to always update the start position,
      //       or to only update it when playback is stopped
      if (!rhomb.isPlaying()) {
        startPosition = rhomb.seconds2Ticks(rhomb.getPosition());
      }
    }
  );

  // transport bar events
  document.getElementById("transportbar").addEventListener("denoto-rewind", 
    function(e){ 
      console.log("[TransportBar] Rewind pressed");
      rhomb.killAllNotes();
      rhomb.moveToPositionTicks(0);
      startPosition = rhomb.seconds2Ticks(rhomb.getPosition());
    });
  
  document.getElementById("transportbar").addEventListener("denoto-play", 
    function(e){ 
      console.log("[TransportBar] Play pressed");
      rhomb.startPlayback();
      startPosition = rhomb.seconds2Ticks(rhomb.getPosition());
    });
  
  document.getElementById("transportbar").addEventListener("denoto-pause", 
    function(e){ 
      console.log("[TransportBar] Pause pressed");
      rhomb.stopPlayback();
      startPosition = rhomb.seconds2Ticks(rhomb.getPosition());
    });
  
  document.getElementById("transportbar").addEventListener("denoto-stop",
     function(e){ 
      console.log("[TransportBar] Stop pressed");
      rhomb.stopPlayback();

      var curPos = rhomb.seconds2Ticks(rhomb.getPosition());

      if (startPosition == curPos) {
        rhomb.moveToPositionTicks(rhomb.getLoopStart());
      }
      else {
        rhomb.moveToPositionTicks(startPosition);
      }

      var posEvent = new CustomEvent("denoto-updatestartpos");
      document.dispatchEvent(posEvent);

      // TODO: could be redundant
      startPosition = rhomb.seconds2Ticks(rhomb.getPosition());
    });
  
  document.addEventListener("denoto-updateloopstart", updateLoopStart);
  document.addEventListener("denoto-updateloopend", updateLoopEnd);

  function updateLoopStart(e){    
    rhomb.setLoopStart(event.detail.start);
  }
  function updateLoopEnd(e){    
    rhomb.setLoopEnd(event.detail.end);
  }
  
  document.getElementById("transportbar").addEventListener("denoto-fastfwd", function(e){ console.log("[TransportBar] Fastfwd pressed") });

  document.getElementById("transportbar").addEventListener("denoto-loopToggle",
     function(e){ 
      console.log("[TransportBar] Loop pressed");
      rhomb.setLoopEnabled(!rhomb.getLoopEnabled());
      console.log("loopEnabled = " + rhomb.getLoopEnabled());
    });

  document.getElementById("savebar").addEventListener("denoto-exp-wav",
   function(e){ 
    console.log("[TransportBar] Export to wav pressed");
    downloadWAV();

    // Hide buttons after export
    save_span.find("#exporttxt").css("visibility", "hidden");
    save_span.find("#exportwav").css("visibility", "hidden");
  });

  document.getElementById("savebar").addEventListener("denoto-exp-txt",
     function(e){ 
      console.log("[TransportBar] Export to txt pressed");
      downloadTxt('track.txt', rhomb.exportSong());

      save_span.find("#exporttxt").css("visibility", "hidden");
      save_span.find("#exportwav").css("visibility", "hidden");
    });

  document.getElementById("savebar").addEventListener("denoto-imp-txt",
     function(e){ 
      console.log("[TransportBar] Import txt pressed");
      $("#txt_input").click();
      txt_input.addEventListener("change", importFile, false);

      // Hide button after import
      save_span.find("#importtxt").css("visibility", "hidden");
  });

  document.getElementById("savebar").addEventListener("denoto-save",
     function(e){ 
      console.log("[TransportBar] Save pressed");
      <% if current_user %>
        <% if url_for(:back).include? '/competitions/' %>
          checkCompetitionParams("<%= url_for(:back).split('/')[-1] %>");
        <% elsif request.original_url.include? '/edit'%>
          uploadFile();
        <% else %>
          openShadowBox("<%= render 'save_track_form' %>", 215, 115);
        <% end %>
      <% else %>
        openShadowBox("<p style='color: #9AB9E5'>Please sign in to save.</p>", 140, 50);
      <% end %>
    });

  // countdown timer events
  //document.getElementById("countdowntimer").addEventListener("denoto-endcountdown", function(e){ console.log("[CountdownTimer] Out of time!") });

  function openShadowBox(content, width, height) {
        Shadowbox.open({
        content:    content,
        player:     "html",
        height:     height ? height : 350,
        width:      width ? width : 350,
        options:   { enableKeys : false }
    });
  }

  Shadowbox.init();

  function get_track_data() {
    $("input[id='track_data']").val(rhomb.exportSong());
  }

  function uploadFile(){
    $.ajax({
      type:'GET',
      url:'/upload/new',
      data: { track_data: rhomb.exportSong(), track_id: '<%= @track.id %>' },
      success: function() {
        openShadowBox("Your change has been saved.", 180, 80);
      },
      error: function(request, status, error) {
        openShadowBox("You cannot edit this song because it's either not yours or because it entered a competition.", 180, 80);
      }
    });
  }

  function importSong(data){
    rhomb.importSong(data);
    
    // initialize the time display
    var timeEvent = new CustomEvent("denoto-setcurrenttime", {"detail": {"measure": 1, "beat": 1, "quarter_beat": 1, "tick": 0}});
    document.dispatchEvent(timeEvent);

    // initialize the BPM display
    var bpm = rhomb.getBpm();
    var bpmEvent = new CustomEvent("denoto-setbpm", {"detail": {"bpm" : bpm}});
    document.dispatchEvent(bpmEvent);
  }

  function downloadTxt(filename, text) {
    var a = document.createElement('a');
    a.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    a.setAttribute('download', filename);
    a.click();
  }

  function downloadWAV(filename, text) {
    var recorderCfg = {"workerPath": "<%= asset_path("recorderWorker.js")%>"};
    var recorder = new Recorder(Tone.Master.output, recorderCfg);
    rhomb.stopPlayback();
    rhomb.moveToPositionSeconds(0);
    recorder.record();
    save_span.prepend("<div id='message' style='position: absolute; right: 130px;'><h3>Recording now..</h3></div>");
    rhomb.startPlayback();

    setTimeout(function(){
      recorder.stop();
      save_span.find("#message").remove();
      recorder.exportWAV(function(blob) {
        Recorder.forceDownload(blob, 'output.wav');
      });
    }, rhomb.getSongLengthSeconds() * 1000);
  }

  function importFile(evt) {
    var files = evt.target.files,
      reader = new FileReader();
    reader.onload = function() {
      importSong(this.result);
      var importEvent = new CustomEvent('denoto-importsong', {"detail": ""});
      document.dispatchEvent(importEvent);
    };
    reader.readAsText(files[0]);
  }

  function checkCompetitionParams(competition_id) {
    $.ajax({
      type:'GET',
      url:'/tracks/check_constraints',
      data: { track_data: rhomb.exportSong(), competition_id: competition_id },
      success: function(response) {
        if(response == "VALID") {
          openShadowBox("<%= render 'competitions/save_track_for_competition', competition_id: url_for(:back).split('/')[-1] %>", 215, 115);
        } else {
          // Let the user know what was wrong
          openShadowBox("<p style='color: #9AB9E5'>" + response + "</p>", 240, 50);
        }
      },
    });
  }
</script>
