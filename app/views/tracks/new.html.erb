<head>
  <link rel="import" href="<%= asset_path("keyboard.html")%>">
  <link rel="import" href="<%= asset_path("blackkey.html")%>">
  <link rel="import" href="<%= asset_path("whitekey.html")%>">
  <link rel="import" href="<%= asset_path("pianoroll.html")%>">
  <link rel="import" href="<%= asset_path("transport.html")%>">
  <link rel="import" href="<%= asset_path("countdown.html")%>">
  <link rel="import" href="<%= asset_path("shadowbox.css")%>">
  <script src="<%= asset_path("shadowbox.js")%>"></script>
</head>

<style type="text/css">
  body{
  }
  #top-bar{
    background: #448;
    width: 100%;
  }
  denoto-transportbar{
    margin-left: auto;
    margin-right: auto;
    width: 30%;
  }
  denoto-countdown{
    margin-left: auto;
    margin-right: auto;
    width: 30%; 
  }
</style>

<div class="img-rounded" id="top-bar">
  <denoto-transportbar id="transportbar"></denoto-transportbar>
  <denoto-countdown id="countdowntimer"></denoto-countdown>
</div>
<div id="midi-interface">
  <denoto-keyboard id="appkeyboard" keycount="24"></denoto-keyboard>
  <denoto-pianoroll id="apppianoroll"></denoto-pianoroll>
</div>
<%= render 'form' %>

<script>
  var rhomb = new Rhombus();
  var lastKeypressed = 0;

  // keyboard events
  document.getElementById("appkeyboard").addEventListener("denoto-keydown", function(e){ 
    rhomb.startPreviewNote(e.detail.keyvalue); 
  });

  document.getElementById("appkeyboard").addEventListener("denoto-keyup", function(e){ rhomb.stopPreviewNote(e.detail.keyvalue); });
  
  // piano roll events
  document.getElementById("apppianoroll").addEventListener("denoto-writenote", function(e){ 
    console.log("[PianoRoll] Writing note " + e.detail.note._pitch + ", tickstart: " + e.detail.note._start + ", tickduration: " + e.detail.note._length); 
    rhomb.insertNote(new rhomb.Note(e.detail.note._pitch, e.detail.note._start, e.detail.note._length));
  });
  document.getElementById("apppianoroll").addEventListener("denoto-erasenote", function(e){ console.log("[PianoRoll] Erasing note " + e.detail.note._pitch + ", tickstart: " + e.detail.note._start + ", tickduration: " + e.detail.note._length); });

  // transport bar events
  document.getElementById("transportbar").addEventListener("denoto-rewind", 
    function(e){ 
      console.log("[TransportBar] Rewind pressed");
      rhomb.moveToPositionTicks(0);
    });
  
  document.getElementById("transportbar").addEventListener("denoto-play", 
    function(e){ 
      console.log("[TransportBar] Play pressed");
      rhomb.startPlayback();
    });
  
  document.getElementById("transportbar").addEventListener("denoto-pause", 
    function(e){ 
      console.log("[TransportBar] Pause pressed");
      rhomb.stopPlayback();
    });
  
  document.getElementById("transportbar").addEventListener("denoto-stop",
     function(e){ 
      console.log("[TransportBar] Stop pressed");
      rhomb.stopPlayback();
      rhomb.moveToPositionTicks(rhomb.getLoopStart());
    });
  
  document.getElementById("transportbar").addEventListener("denoto-fastfwd", function(e){ console.log("[TransportBar] Fastfwd pressed") });

  document.getElementById("transportbar").addEventListener("denoto-loopToggle",
     function(e){ 
      console.log("[TransportBar] Loop pressed");
      rhomb.setLoopEnabled(!rhomb.getLoopEnabled());
      console.log("loopEnabled = " + rhomb.getLoopEnabled());
    });

  document.getElementById("transportbar").addEventListener("denoto-export",
     function(e){ 
      console.log("[TransportBar] Export pressed");
      openShadowBox(rhomb.exportSong(), 350, 350);
    });

  document.getElementById("transportbar").addEventListener("denoto-import",
     function(e){ 
      console.log("[TransportBar] Import pressed");
      openShadowBox("<textarea id='track-text' rows='17' cols='52'>Paste a track here</textarea><button type='button' class='btn btn-default import-btn' onclick='importSong(document.getElementById(&quot;track-text&quot;).value, 350, 350)'>Import</button>");
    });

  document.getElementById("transportbar").addEventListener("denoto-save",
     function(e){ 
      console.log("[TransportBar] Save pressed");
      openShadowBox("<form accept-charset='UTF-8' action='/tracks' id='new_track' method='post' onsubmit='uploadFile()'><div style='display:none'><input name='utf8' type='hidden' value='âœ“'><input name='authenticity_token' type='hidden' value='mnRME6RZFa3XHMDQsTLC0oZi7FLO1IlbBt2SowWhyhM='></div><div class='field'>Title<br><input id='track_title' name='track[title]' type='text'></div><div class='actions'><input class='btn btn-primary' name='commit' type='submit' value='Save'></div></form>", 200, 100);
    });

  // countdown timer events
  document.getElementById("countdowntimer").addEventListener("denoto-endcountdown", function(e){ console.log("[CountdownTimer] Out of time!") });

  function openShadowBox(content, width, height) {
        Shadowbox.open({
        content:    content,
        player:     "html",
        height:     height,
        width:      width
    });
  }
  Shadowbox.init();

  function uploadFile(){
    $.ajax({
      type:'GET',
      url:'/upload/new',
      data: { track_data: rhomb.exportSong(), track_title: document.getElementById("track_title").value},
      success: function() {
        Shadowbox.close();
      }
    });
  }

  function importSong(data){
    rhomb.importSong(data);
    Shadowbox.close();
  }
</script>